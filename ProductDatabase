package src;

import java.io.File;
import java.io.FileWriter;
import java.io.PrintWriter;
import java.util.Scanner;

public class ProductDatabase {
	
	public static Scanner input = new Scanner (System.in);
    public static LinkedList<Product> products = new LinkedList<Product> (); //linked list to store all products

    public LinkedList<Product>  getProductDatabase() { //returns the list of all products
        return products;
    }
    
    public ProductDatabase (String fileName) {
        
       try{
                File file = new File(fileName);
                Scanner read = new Scanner (file);
                String line = read.nextLine(); //skips header line
                
                while(read.hasNext())
                {
                    line = read.nextLine();
                    String [] data = line.split(","); //data is stored in CSV
                    
                    int productID = Integer.parseInt(data[0]);
                    String name =  data[1].trim();//to remove spaces
                    double price = Double.parseDouble(data[2]);
                    int stock = Integer.parseInt(data[3]);

                    Product product = new Product(productID, name, price, stock );
                    products.insert(product);
                }
                read.close();
            }
            catch (Exception ex) {
                System.out.println(ex.getMessage());//print error if file not found or corrupted
            }
    }
    
    public void addProduct()
    {
        System.out.println("Enter product ID:");
        int productID = input.nextInt();
        while (checkProductID(productID))
        {
            System.out.println("ID already taken, enter different product ID again:");
            productID = input.nextInt();
        }
        
        System.out.println("Enter product name:");
        String name =input.next();
        
        System.out.println("Enter product price:");
        double price = input.nextDouble();
        
        System.out.println("Enter product stock:");
        int stock = input.nextInt();
        
        Product product = new Product(productID, name, price, stock);
        products.findFirst();
        products.insert(product);
        writeToFile();
    }
    
    public Product searchProductID() {
        if (products.empty()) {
            System.out.println("Products are Empty");
        }
        else {
            System.out.println("Enter product ID: ");
            int productID = input.nextInt();
            
            boolean found = false;
            
            products.findFirst();
            while (!products.last())
            {
                if (products.retrieve().getProductID()== productID)
                {
                    found = true;
                    break;
                }
                products.findNext();
            }
            if (products.retrieve().getProductID()== productID) //to check the last element
                found = true;
        
            if (found )
                return products.retrieve(); //return the founded product
        }
        System.out.println("No product with this ID");
        return null;
    }
    
    public Product removeProduct() {
        if (products.empty()) {
        	System.out.println("There are no products");
        }
        else {
            System.out.println("Enter product ID: ");
            int productID = input.nextInt();
            
            boolean exists = false;
            
            products.findFirst();
            while (!products.last()) {
                if (products.retrieve().getProductID()==productID) {
                    exists = true;
                    break;
                }
                products.findNext();
            }
            if (products.retrieve().getProductID()==productID)
                exists = true;
        
            if (exists){
            	Product p = products.retrieve();
                products.remove();
                p.setStock(0); //set stock to 0 to mark as removed
                products.insert(p);
                writeToFile();
                return p;
            }
        }
        System.out.println("No product with this ID");
        return null;
    }

    public Product updateProduct() { 
        if (products.empty()) {
            System.out.println("There are no products");
        }
        else {
            System.out.println("Enter product ID: ");
            int productID = input.nextInt();
            
            boolean exists = false;
            
            products.findFirst();
            while (!products.last()) {
                if (products.retrieve().getProductID() == productID && products.retrieve().getStock() != -1) {
                    exists = true;
                    break;
                }
                products.findNext();
            }
            if (products.retrieve().getProductID()== productID && products.retrieve().getStock() != -1)
                exists = true;
        
            if (exists) {
                Product p = products.retrieve();
                products.remove();
                
                //Display update options
                System.out.println("1. Update Name");
                System.out.println("2. Update Price");
                System.out.println("3. Update Stock");
                System.out.println("Pick an option: ");
                int choice = input.nextInt();
                
                switch (choice) {
                    case 1: { //Update Name
                        System.out.println("New Product Name:");
                        p.setName(input.next());
                        products.insert(p);
                        writeToFile();
                    }
                    break;
                    
                    case 2: { //Update Price
                        System.out.println("New Price:");
                        p.setPrice( input.nextDouble());
                        products.insert(p);
                        writeToFile();
                    }
                    break;
                    
                    case 3:  { //Update Stock
                        System.out.println("New Stock:");
                        int stock = input.nextInt();
                        p.setStock(stock);
                        products.insert(p);
                        writeToFile();
                    }
                    break;
                    
                    default:
                        System.out.println("Invalid Option");
                }
                return p;
            }
        }
        System.out.println("No product with this ID");
        return null;
    }

    public Product searchProductName() { //searches for a product by name
        if (products.empty()) 
            System.out.println("There are no products");
        else {
            System.out.println("Enter Product Name:");
            String name = input.nextLine(); //to handle leftover newline character
            name = input.nextLine();

            products.findFirst();
            for ( int i = 0 ; i < products.size() ; i++)
            {
                if (products.retrieve().getName().compareToIgnoreCase(name)==0)
                    return products.retrieve();
                products.findNext();
            }
        }

        System.out.println("No product with this name");
        return null;
    }
    
    public void outOfStock() //displays all products that are out of stock
    {
        if (products.empty())
        {
            System.out.println("There are no products");
        }
        else
        {
            products.findFirst();
            for ( int i = 0 ; i < products.size() ; i++)
            {
                if (products.retrieve().getStock() == 0)
                    System.out.println(products.retrieve());    
                products.findNext();
            }
        }
    }

    public boolean checkProductID( int productID ) //checks if a product ID already exists in the database
    {
        if (! products.empty())
        {
            products.findFirst();
            for ( int i = 0 ; i< products.size() ; i++)
            {
                if (products.retrieve().getProductID() == productID)
                    return true; //ID already taken
                products.findNext();
            }
        }
        return false ;
    }
    
    public boolean availableProductID( int productID )
    {
        if (! products.empty())
        {
            products.findFirst();
            for ( int i = 0 ; i< products.size() ; i++)
            {
                if (products.retrieve().getProductID() == productID && products.retrieve().getStock() != -1)
                    return true;
                products.findNext();
            }
        }
        return false ;
    }

    public Product getProductData ( int productID ) //retrieves a product by its ID 
    {
        if (! products.empty())
        {
            products.findFirst();
            while (!products.last())
            {
                if (products.retrieve().getProductID() == productID)
                    return products.retrieve();
                products.findNext();
            }
            if (products.retrieve().getProductID()== productID)
                return products.retrieve();
        }
        return null;
    }
    
    public void writeToFile() {
        try (PrintWriter pw = new PrintWriter(new FileWriter("products.csv"))) {
            pw.println("ProductID,Name,Price,Stock"); // header
            products.findFirst();
            for (int i = 0; i < products.size(); i++) {
                Product p = products.retrieve();
                pw.println(p.getProductID() + "," + p.getName() + "," + p.getPrice() + "," + p.getStock());
                products.findNext();
            }
        } catch (Exception e) {
            System.out.println("Error writing to " + "products.csv" + ": " + e.getMessage());
        }
    }

}
