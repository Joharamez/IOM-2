package src;

import java.io.File;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Scanner;
import java.io.FileWriter;
import java.io.PrintWriter;

public class OrderDatabase {
	 
    public static Scanner input = new Scanner (System.in);
    public static LinkedList<Order> orders = new LinkedList<Order> ();
    
    
    public LinkedList<Order> getOrderDatabase(){
        return orders;
    }
    
    
    public OrderDatabase(String fileName){
        try{
                File file = new File(fileName);
                Scanner read = new Scanner (file);
                String line = read.nextLine();
                
                while(read.hasNext()){
                    line = read.nextLine();
                    String [] ordersData = line.split(","); 
                    int orderID = Integer.parseInt(ordersData[0]);
                    int customerID = Integer.parseInt(ordersData[1]);
                    
                    String  pp =  ordersData[2].replaceAll("\"", "");
                    String [] p = pp.split(";");
                    Integer [] productIDs = new Integer [p.length];
                    for (int i = 0 ; i< productIDs.length ; i++)
                        productIDs[i] = new Integer(Integer.parseInt(p[i].trim()));
                    double price = Double.parseDouble(ordersData[3]);
                    String date = ordersData[4];
                    String status = ordersData[5];
                            
                    Order order = new Order(orderID, customerID, productIDs, price, date, status );
                    orders.insert(order);
                    
                }
                read.close();
            }
            catch (Exception ex) {
                System.out.println(ex.getMessage());
            }
     }

   
    public int cancelOrder(int orderID){
        orders.findFirst();
        for (int i=0;i<orders.size();i++)  {
            if (orders.retrieve().getOrderID() == orderID) {
                if (orders.retrieve().status.compareToIgnoreCase("cancelled") == 0) {
                    System.out.println("This order was cancelled before");
                    return 2; //canceled before 
                }
                    
                Order order = orders.retrieve(); 
                order.status = "cancelled";
                orders.insert(order);
                writeToFile();
                return 1; //cancelled 
            }
            else
                orders.findNext();
        }
        return 0; // order not found
    }
    

    public boolean updateOrder(int orderID) {
         boolean found = false;
        orders.findFirst();
        while (!orders.last()) {
            if (orders.retrieve().getOrderID()== orderID) {
                found = true;
                break;
            }
            orders.findNext();
        }
        if (orders.retrieve().getOrderID()== orderID)
            found = true;

        if (found) {
            if (orders.retrieve().getStatus().compareToIgnoreCase("cancelled") ==0){
                System.out.println("Order status could not be changed");
                return false;
            }
             else {
                Order obj = orders.retrieve();
                
                System.out.println("Enter new order status:");
                String str = input.next();
                orders.remove();
                obj.status = str;
                orders.insert(obj);
                writeToFile();
                return true;
            }
        }
        System.out.println("Order does not exist");
        return false;
    }
    
       
    public Order searchOrderID(int orderID) {
        boolean found = false;

        orders.findFirst();
        while (!orders.last()){
            if (orders.retrieve().getOrderID()== orderID) {
                found = true;
                break;
            }
            orders.findNext();
        }
        if (orders.retrieve().getOrderID()== orderID)
            found = true;

        if (found)
            return orders.retrieve();

        System.out.println("Order does not exist");
        	return null;
    }

  
    public LinkedList<Order> ordersBetweenDates(String date1, String date2) {
        LinkedList<Order> ordersbetweenDates =  new LinkedList<Order>();
        
        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/mm/yyyy");
        LocalDate Ldate1 = LocalDate.parse(date1, formatter);
        LocalDate Ldate2 = LocalDate.parse(date2, formatter);
        
        if (!orders.empty()) {
            orders.findFirst();
            
            for (int i = 0;i<orders.size();i++){
                if (orders.retrieve().getDate().isAfter(Ldate1) && orders.retrieve().getDate().isBefore(Ldate2)){
                    ordersbetweenDates.insert(orders.retrieve());
                    System.out.println(orders.retrieve());
                }
               orders.findNext();
            }
        }
        return ordersbetweenDates;
   }
  
    public boolean checkOrderID(int orderID) {
        if (!orders.empty()) {
            orders.findFirst();
            while (!orders.last()) {
                if (orders.retrieve().getOrderID() == orderID)
                    return true;
                orders.findNext();
            }
            if (orders.retrieve().getOrderID() == orderID)
                return true;
        }
        return false;
    }
    
    public void writeToFile() {
        try (PrintWriter pw = new PrintWriter(new FileWriter("orders.csv"))) {
            pw.println("OrderID,CustomerID,ProductIDs,TotalPrice,Date,Status");
            orders.findFirst();
            for (int i = 0; i < orders.size(); i++) {
                Order o = orders.retrieve();
                // combine product IDs with semicolons
                StringBuilder productIds = new StringBuilder("\"");
                o.getProducts().findFirst();
                for (int j = 0; j < o.getProducts().size(); j++) {
                    productIds.append(o.getProducts().retrieve());
                    if (j < o.getProducts().size() - 1)
                        productIds.append(";");
                    o.getProducts().findNext();
                }
                productIds.append("\"");
                pw.println(o.getOrderID() + "," + o.getCustomerReference() + "," +
                           productIds + "," + o.getTotalPrice() + "," +
                           o.getDate() + "," + o.getStatus());
                orders.findNext();
            }
        } catch (Exception e) {
            System.out.println("Error writing orders: " + e.getMessage());
        }
    }
    
}
