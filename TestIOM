import java.io.File;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Scanner;
public class TestIOM {
    
    public static Scanner input = new Scanner (System.in);
    
    public static ProductDatabase productData = new ProductDatabase("prodcuts.csv");
    public static LinkedList<Product>  products;
    
    public static CustomerDatabase customerData = new CustomerDatabase("customers.csv");
    public  static LinkedList<Customer> customers;
    
    public static OrderDatabase orderData = new OrderDatabase("orders.csv");
    public static LinkedList<Order>  orders;
    
    public static ReviewDatabase reviewData = new ReviewDatabase("reviews.csv");
    public static LinkedList<Review> reviews;
    



public static void readData(){
    products= productData.getProductDatabase();
    customers = customerData.getCustomerDatabase();
    orders = orderData.getOrderDatabase();
    reviews = reviewData.getReviewDatabase();
	
  ///add Orders To Customers
    customers.findFirst();
    for(int i=0; i<customers.size(); i++) {
        orders.findFirst();
        for (int j=0;j<orders.size();j++) {
            if (customers.retrieve().getCustomerID() == orders.retrieve().getCustomerReference()) {
                int orderID =orders.retrieve().getOrderID();
                customers.retrieve().addOrder(orderID);
            }
            orders.findNext();
        }
        customers.findNext();
    }
    
    ///add Reviews To products
    products.findFirst();
    for(int i=0; i<products.size(); i++) {
        reviews.findFirst();
        for (int j=0;j<reviews.size();j++){
            if (products.retrieve().getProductID() == reviews.retrieve().getProduct()) {
                int reviewID =reviews.retrieve().getReviewID();
                products.retrieve().addReview(reviewID);
            }
            reviews.findNext();
        }
        products.findNext();
    }
    
    
}
public static void main(String[]args) {
	
	int managerChoice;
	int productChoice;
	int customerChoice;
	int orderChoice;
	int reviewChoice;
	do {// manager menu
		System.out.println("*Inventory Management System*");
		System.out.println("Please enter your choice");
		System.out.println("1.Products");
		System.out.println("2.Customers");
		System.out.println("3.Orders");
		System.out.println("4.Reviews");
		System.out.println("5.Exit");
		managerChoice=input.nextInt();
		
		switch(managerChoice) { 
		
		case 1:// products menu
			do {
				System.out.println("Enter your choice:");
		        System.out.println("1.Add new product");
		        System.out.println("2.Remove a product");
		        System.out.println("3.Update a product");
		        System.out.println("4.Search for a product"); // id or name
		        System.out.println("5.Track out-of-stock products");
		        System.out.println("6.Return to the main menu");
		        productChoice = input.nextInt();
		        
		        switch(productChoice) {
		        case 1: //Add new product
		        	productData.addProduct();
		        	break;
		        case 2: //Remove a product
		        	productData.removeProduct();
		        	break;
		        case 3://Update a product
		        	productData.updateProduct();
		        	break;
		        case 4: //Search for a product
					System.out.println("Enter your choice:");
		        	System.out.println("1. Search by ID");
		        	System.out.println("2. Search by name");
		        	int searchChoice=input.nextInt();

		        	switch(searchChoice) {
		        	case 1:// Search by ID
		                Product productID = productData.searchProductID();
		                if (productID != null)
		                    System.out.println(productID);
		        	break;
		        	case 2:// Search by name
		                Product prouctName = productData.searchProductName();
		                if (prouctName != null)
		                    System.out.println(prouctName);
		        		break;
		        	}
		        	
		        	break;
		        case 5: //Track out-of-stock products
		        	productData.outOfStock();
		        	break;
		        	
		        case 6://exit
		        	break;
		        }
				
			}while (productChoice!=6);
			break;
			
		case 2:// Customer Menu
			System.out.println("Enter your choice");
	        System.out.println("1.Register new customer");
	        System.out.println("2.Place an order for a specific customer");
	        System.out.println("3.View order history");
	        System.out.println("4.Return to the main menu");
	        customerChoice = input.nextInt();;
	        switch (customerChoice) {
	        case 1: //Register new customer"
	        	customerData.registerCustomer();
	        	break;
	        case 2: //Place an order
	        	placeOrder();
	        	break;
	        case 3: //View order history"
	        	customerData.orderHistory();
	        	break;
	        	
	        case 4:
	        	break;
	        }
			break;
			
		case 3:// Order Menu
			System.out.println("Enter your choice");
			System.out.println("1.Create an order");
	        System.out.println("2.Cancel order");
	        System.out.println("3.Update order status");
	        System.out.println("4.Search for an order");
	        System.out.println("5.Display orders between dates");
	        System.out.println("6.Return to the main menu");
	        orderChoice = input.nextInt();
	        
	        switch (orderChoice) {
	        case 1: //Create an order
	        	placeOrder();
	        	break;
	        	
	        case 2: //Cancel order
	        	cancelOrder();
	        	break;
	        	
	        case 3://Update order status
                if (orders.empty())
                    System.out.println("There is no order history");
                else
                {
                    System.out.println("Enter order ID:");
                    int orderID = input.nextInt();
                    orderData.updateOrder(orderID);
                }
	        	break;
	        	
	        case 4: //Search for an order
                if (orders.empty())
                    System.out.println("There is no order history");
                else
                {
                    System.out.println("Enter order ID:");
                    int orderID = input.nextInt();
                    System.out.println(orderData.searchOrderID(orderID));
                }
	        	break;
	        	
	        case 5://Display orders between dates
	        	System.out.println("Enter first date (dd/MM/yyyy)");
                String date1 = input.next();
                
                System.out.println("Enter second date (dd/MM/yyyy)");
                String date2 = input.next();
                
                orderData.ordersBetweenDates(date1,date2);
	            break;
	        	
	        case 6://exit
	        	break;
	        }
			break;
			
		case 4: //Review Menu
			System.out.println("Enter your choice");
	        System.out.println("1.Add review");
	        System.out.println("2.Edit review");
	        System.out.println("3.Get an average rating for product");
	        System.out.println("4.Top 3 products");
	        System.out.println("5.Common products with an average rating 4+");
	        System.out.println("6.Return Main menu");
	        reviewChoice = input.nextInt();
	        
	        switch(reviewChoice) {
	        case 1://Add review
	        	break;
	        	
	        case 2: //Edit review
	        	break;
	        	
	        case 3: //Get an average rating for product
	        	break;
	        	
	        case 4: //Top 3 products
	        	break;
	        	
	        case 5://Common products with an average rating 4+
	        	break;
	        	
	        case 6://exit
	        	break;
	        	
	        	
	        }
	        
			break;
		}
	} while (managerChoice!=5);

	


}

public static void createReview() {

    System.out.println("Enter customer ID:");
    int customerID =input.nextInt();
    while (!customerData.checkCustomerID(customerID)) {
        System.out.println("customer ID not available, Re-enter again");
        customerID =input.nextInt();
    }
    
    System.out.println("Enter product ID :");
    int productID =input.nextInt();
    while (!productData.checkProductID(productID)) {
        System.out.println("product ID not available, Re-enter again");
        productID =input.nextInt();
    }
    
    Review review = reviewData.addReview(customerID, productID);
    System.out.println(review.toString());
	
}

public static void placeOrder() {
	 Order newOrder = new Order();
     double totalPrice = 0;
     
     System.out.println("Enter order ID:");
     int orderID = input.nextInt();
     while (orderData.checkOrderID(orderID)){
         System.out.println("Order ID already exists, please re-enter");
         orderID = input.nextInt();
     }
     newOrder.setOrderID(orderID);
     
     System.out.println("Enter customer ID:");
     int customerID = input.nextInt();
     while(!customerData.checkCustomerID(customerID))
     {
         System.out.println("Customer with the entered ID does not exist, please re-enter");
         customerID = input.nextInt();
     }
     newOrder.setCustomerReference(customerID);
     
     char answer = 'y';
     while (answer == 'y' || answer == 'Y') { 
         System.out.println("Enter product ID:");
         int productID = input.nextInt();
        
         boolean found = false;
         
         products.findFirst();
         for (int i=0; i<products.size(); i++) {
             if (products.retrieve().getProductID() == productID) {
                 if (products.retrieve().getStock() == 0)
                     System.out.println("Product out of stock");
                 else {
                     Product pp = products.retrieve();
                     products.remove();
                     pp.setStock(pp.getStock()-1);
                     products.insert(pp);
                     System.out.println("Product added to order");
                     found = true;
                     
                     newOrder.addProduct(pp.getProductID());
                     totalPrice += pp.getPrice();
                 }
                 break;
             }
             products.findNext();
         }

         if (!found)
                 System.out.println("Product with this ID does not exist");
             
         
         System.out.println("Do you want to continue adding a product?");
         answer = input.next().charAt(0);
     }
     
     newOrder.setTotalPrice(totalPrice);
     
     System.out.println("Enter the date:");
     DateTimeFormatter formatter = DateTimeFormatter.ofPattern("dd/mm/yyyy");
     LocalDate Ldate = LocalDate.parse(input.next(), formatter);
     newOrder.setDate(Ldate);

     System.out.println("Enter new status:");
     newOrder.setStatus(input.next());
     
     orders.insert(newOrder);
     

     customers.findFirst();
     for(int i = 0; i<customers.size(); i++) {
         if (customers.retrieve().getCustomerID() == newOrder.getCustomerReference()) {
             Customer customer = customers.retrieve();
             customers.remove();
             customer.addOrder(orderID);
             customers.insert(customer);
             break;
         }
         customers.findNext();
     }   
     
     System.out.println("Order added successfully");
     System.out.println(orders.retrieve());
}
	

public static void cancelOrder() {
	 System.out.println("Please enter order ID:");
     int orderID = input.nextInt();
     Order cancelOrder = orderData.searchOrderID(orderID);
     while (cancelOrder == null){
         System.out.println("Order ID does not exist, please re-enter");
         orderID = input.nextInt();
         cancelOrder = orderData.searchOrderID(orderID);
     }
 
     if (orderData.cancelOrder(orderID) == 1) {
         customers.findFirst();
         for (int i=0; i<customers.size; i++) {
             if (customers.retrieve().getCustomerID() == cancelOrder.getCustomerReference()) {
                 Customer customer = customers.retrieve();
                 customers.remove();
                 customer.removeOrder(cancelOrder.getOrderID());
                 customers.insert(customer);
                 break;
             }
             customers.findNext();
         }
         
         cancelOrder.getProducts().findFirst();
         for (int j=0; j<cancelOrder.getProducts().size(); j++)
         {
                 products.findFirst();
                 for (int i=0; i<products.size(); i++) {
                     if (products.retrieve().getProductID() == cancelOrder.getProducts().retrieve().byteValue())
                         products.retrieve().addStock(1);
                     products.findNext();
                 }
                 cancelOrder.getProducts().findNext();
         }
         
         System.out.println("Order has been cancelled") ;
     }    
	
}

public static float averageRating(int productID) {
	int counter =0;
    float rate = 0;
    
    reviews.findFirst();
    while (! reviews.last())
    {
        if (reviews.retrieve().getProduct() == productID)
        {
            counter ++;
            rate += reviews.retrieve().getRating();
        }
        reviews.findNext();
    }
    if (reviews.retrieve().getProduct() == productID)
    {
        counter ++;
        rate += reviews.retrieve().getRating();
    }
    
    return (rate/counter);
	
}

 public static void top3Products(){

     LinkedPQ<Product> top3 = new LinkedPQ<Product> ();
     
     if (!products.empty())
     {
         products.findFirst();
         for (int i = 0 ; i < products.size() ; i++)
         {
             
             Product p = products.retrieve();
             double AVGrating = averageRating (p.productID);
             top3.enqueue(p, AVGrating);
             
             products.findNext();
         }
         
     }
     
     System.out.println("top 3 products by average rating from most to least.");
     for ( int j = 1 ; j <= 3 && top3.length() > 0 ; j++)
     {
         PQElement<Product> top = top3.serve();
         System.out.println("Product " + j + "  " + top.data.getProductID() 
                 + " " + top.data.getName() + " AVG rate (" + top.priority + ")" );
     }
	 
 }
 
 public static void commonProducts(int customerID1,int customerID2) {
	        LinkedList<Integer> pcustomer1 = new LinkedList<Integer> ();
	        LinkedList <Integer> pcustomer2 = new LinkedList <Integer> ();
	        
	        //1. find all products for customer1 1 and customer 2 that are reviewd
	        // for each customer in linked list 
	        reviews = reviewData.getReviewDatabase();
	        
	        if (! reviews.empty())
	        {
	            reviews.findFirst();
	            for (int i =1 ;i <= reviews.size() ; i++)
	            {
	                if (reviews.retrieve().getCustomer() == customerID1 )
	                {
	                    pcustomer1.findFirst();
	                    boolean found1 = false;
	                    for (int x = 1; x <= pcustomer1.size() ; x++)
	                    {
	                        if (pcustomer1.retrieve() == reviews.retrieve().getProduct())
	                        {
	                            found1 = true;
	                            break;
	                        }
	                        pcustomer1.findNext();
	                    }
	                    pcustomer1.findFirst();
	                    if (! found1 )
	                        pcustomer1.insert(reviews.retrieve().getProduct());
	                }
	                
	                if (reviews.retrieve().getCustomer() == customerID2 )
	                {
	                    pcustomer2.findFirst();
	                    boolean found2 = false;
	                    for (int x = 1; x <= pcustomer2.size() ; x++)
	                    {
	                        if (pcustomer2.retrieve() == reviews.retrieve().getProduct())
	                        {
	                            found2 = true;
	                            break;
	                        }
	                        pcustomer2.findNext();
	                    }
	                    
	                    pcustomer2.findFirst();
	                    if (! found2 )
	                        pcustomer2.insert(reviews.retrieve().getProduct());
	                }
	                reviews.findNext();
	            }
	            
	            pcustomer1.print();
	            pcustomer2.print();
	            
	            // find common products for both lists
	            // add common after finding avg rate > 4 in new linked list
	            LinkedPQ<Product> AVGrate45 = new LinkedPQ<Product> ();
	            if (! pcustomer1.empty() && ! pcustomer2.empty())
	            {
	                pcustomer1.findFirst();
	                for ( int m =1; m <= pcustomer1.size() ; m++)
	                {
	                    int productID = pcustomer1.retrieve();
	                    pcustomer2.findFirst();
	                    for (int n = 1 ; n <= pcustomer2.size() ; n++)
	                    {
	                        if ( productID == pcustomer2.retrieve())
	                        {
	                            double AVGrating = averageRating (productID);
	                            if ( AVGrating >= 4)
	                            {
	                                Product p = productData.getProductData(productID);
	                                AVGrate45.enqueue(p, AVGrating);
	                            }
	                        }
	                        pcustomer2.findNext();
	                    }
	                    pcustomer1.findNext();
	                }                
	            
	                // printing common products
	                System.out.println("Common Products with rate above 4 are ");
	                while (AVGrate45.length() > 0)
	                {
	                    PQElement<Product> product_rate = AVGrate45.serve();
	                    System.out.println(" Product (" + product_rate.data.productID + ") " + product_rate.data.getName() + " with rate " + product_rate.priority );
	                    System.out.println(product_rate.data);
	                    System.out.println("\n");
	                }
	            }
	            else
	                System.out.println("NO COMMON products between the two customers ");
	        }
	        else
	            System.out.println("Reviews not available for all products");
	    }
	 
 }

